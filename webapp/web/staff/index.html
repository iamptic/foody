<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Foody ‚Äî –¢–∞–±–ª–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—É</title><link rel="stylesheet" href="/web/style.css"/>
<script src="https://telegram.org/js/telegram-web-app.js"></script><script src="/config.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script></head><body>
<div class="container">
  <h2>üßæ –¢–∞–±–ª–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—É</h2>
  <div class="card">
    <div class="row">
      <div class="col"><label class="small">Restaurant ID</label><input id="rid" class="input" placeholder="RID_..."/></div>
      <div class="col"><label class="small">API Key</label><input id="apikey" class="input" placeholder="–≤–∞—à –∫–ª—é—á"/></div>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btnSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn secondary" id="btnStartScan">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä QR</button>
    </div>
  </div>

  <div class="card">
    <div id="reader" style="max-width:480px"></div>
    <div style="margin-top:8px" class="row">
      <div class="col"><input id="resId" class="input" placeholder="Reservation ID"/></div>
      <div class="col"><input id="code" class="input" placeholder="–ö–æ–¥"/></div>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px">
      <button class="btn" id="btnCheck">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
      <button class="btn" id="btnRedeem">–ü–æ–≥–∞—Å–∏—Ç—å</button>
    </div>
    <pre id="out" class="small" style="white-space:pre-wrap;background:#f7f7fb;padding:10px;border-radius:12px;border:1px solid #e5e7eb;margin-top:8px"></pre>
  </div>
</div>
<div id="toast" class="toast"></div>

<script>
const tg=window.Telegram?.WebApp;if(tg){tg.expand();tg.setHeaderColor('#ffffff');tg.setBackgroundColor('#ffffff');}
const toast=(t)=>{const el=document.getElementById('toast');el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1500)};
const api=()=>window.BACKEND_PUBLIC; const rid=()=>document.getElementById('rid').value.trim(); const key=()=>document.getElementById('apikey').value.trim();
function save(){localStorage.setItem('foody_restaurant', JSON.stringify({id: rid()})); localStorage.setItem('api_key', key()); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');}
function load(){const r=JSON.parse(localStorage.getItem('foody_restaurant')||'{}'); if(r.id) document.getElementById('rid').value=r.id; const k=localStorage.getItem('api_key'); if(k) document.getElementById('apikey').value=k;}
function parseQR(text){ try{const parts=text.split('|'); if(parts[0]==='FOODY'){ return {resId:parts[1], code:parts[2]}; }}catch(e){} return null; }
let scanner=null;
document.getElementById('btnStartScan').onclick=()=>{
  const el=document.getElementById('reader');
  if(scanner){scanner.stop().then(()=>{scanner=null; el.innerHTML='';}); return;}
  scanner=new Html5Qrcode('reader');
  scanner.start({ facingMode: "environment" }, { fps:10, qrbox: 250 }, (decodedText)=>{
    const p=parseQR(decodedText); if(p){document.getElementById('resId').value=p.resId; document.getElementById('code').value=p.code; toast('–°—á–∏—Ç–∞–Ω–æ');}
  }).catch(e=>{document.getElementById('out').textContent='–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: '+e;});
};
function showResult(prefix, ok, payload){
  const el=document.getElementById('out');
  if(ok){
    el.innerHTML = `<div class="badge">OK</div> ${prefix}
      <div class="small">–†–µ–∑–µ—Ä–≤–∞—Ü–∏—è: <b>${(payload.reservation_id||payload.reservationId||'')}</b></div>
      <div class="small">–ö–æ–¥: <b>${payload.code||''}</b></div>
      <div class="small">–°—Ç–∞—Ç—É—Å: <b>${payload.status||''}</b></div>`;
  }else{
    el.textContent = `${prefix} ERROR\n${payload}`;
  }
}
async function check(){
  const url=`${api()}/api/v1/merchant/check_code?restaurant_id=${encodeURIComponent(rid())}&code=${encodeURIComponent(document.getElementById('code').value.trim())}&res_id=${encodeURIComponent(document.getElementById('resId').value.trim())}`;
  const r=await fetch(url, {headers:{'X-Foody-Key': key()}});
  const txt=await r.text();
  try{ showResult('CHECK ‚Üí', r.ok, JSON.parse(txt)); } catch{ showResult('CHECK ‚Üí', r.ok, txt); }
}
async function redeem(){
  const body={restaurant_id: rid(), code: document.getElementById('code').value.trim()||undefined, res_id: document.getElementById('resId').value.trim()||undefined};
  const r=await fetch(`${api()}/api/v1/merchant/redeem`, {method:'POST', headers:{'Content-Type':'application/json','X-Foody-Key': key()}, body:JSON.stringify(body)});
  const txt=await r.text();
  try{ showResult('REDEEM ‚Üí', r.ok, JSON.parse(txt)); } catch{ showResult('REDEEM ‚Üí', r.ok, txt); }
  if(r.ok){ document.getElementById('code').value=''; document.getElementById('resId').value=''; }
}
document.getElementById('btnSave').onclick=save;
document.getElementById('btnCheck').onclick=check;
document.getElementById('btnRedeem').onclick=redeem;
window.addEventListener('load', load);
</script>
</body></html>
