<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Foody ‚Äî –í–∏—Ç—Ä–∏–Ω–∞</title><link rel="stylesheet" href="/web/style.css"/>
<script src="https://telegram.org/js/telegram-web-app.js"></script><script src="/config.js"></script></head><body>
<div class="container">
  <h2>üõí –í–∏—Ç—Ä–∏–Ω–∞</h2>
  <div class="card">
    <div class="row">
      <div class="col"><label class="small">–ì–æ—Ä–æ–¥ (–ø—Ä–µ—Å–µ—Ç)</label>
        <select id="city" class="input">
          <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>
          <option value="55.7558,37.6176">–ú–æ—Å–∫–≤–∞</option>
          <option value="59.9343,30.3351">–°–∞–Ω–∫—Ç‚Äë–ü–µ—Ç–µ—Ä–±—É—Ä–≥</option>
          <option value="56.8389,60.6057">–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥</option>
          <option value="55.0302,82.9204">–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫</option>
          <option value="43.1176,131.899">–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫</option>
        </select>
      </div>
      <div class="col"><label class="small">–†–∞–¥–∏—É—Å, –∫–º</label><input id="radius" class="input" placeholder="3"/></div>
    </div>
    <div class="row">
      <div class="col"><label class="small">Lat</label><input id="lat" class="input" placeholder="–∞–≤—Ç–æ"/></div>
      <div class="col"><label class="small">Lng</label><input id="lng" class="input" placeholder="–∞–≤—Ç–æ"/></div>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btnGeo">üìç –ú–æ—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è</button>
      <button class="btn" id="btnLoad">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</button>
      <button class="btn secondary" id="btnSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
    </div>
  </div>
  <div id="list"></div>
</div>
<div id="toast" class="toast"></div>
<script>
const toast=(t)=>{const el=document.getElementById('toast');el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1500)};
const tg=window.Telegram?.WebApp;if(tg){tg.expand();tg.setHeaderColor('#ffffff');tg.setBackgroundColor('#ffffff');}
function priceFmt(c){return (c/100).toFixed(2).replace('.',',')+' ‚ÇΩ'}

function saveFilters(){
  localStorage.setItem('foody_filters', JSON.stringify({
    lat: document.getElementById('lat').value.trim(),
    lng: document.getElementById('lng').value.trim(),
    radius: document.getElementById('radius').value.trim(),
    city: document.getElementById('city').value
  }));
  toast('–§–∏–ª—å—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
}
function loadFilters(){
  try{
    const f=JSON.parse(localStorage.getItem('foody_filters')||'{}');
    if(f.city) document.getElementById('city').value=f.city;
    if(f.lat) document.getElementById('lat').value=f.lat;
    if(f.lng) document.getElementById('lng').value=f.lng;
    if(f.radius) document.getElementById('radius').value=f.radius;
  }catch(e){}
}

async function loadOffers(){
  const base=window.BACKEND_PUBLIC;
  const rid=document.getElementById('rid')?.value?.trim?.()||'';
  const lat=document.getElementById('lat').value.trim();
  const lng=document.getElementById('lng').value.trim();
  const radius=document.getElementById('radius').value.trim();

  async function fetchOffers(useGeo){
    const p=new URLSearchParams({});
    if(rid) p.set('restaurant_id', rid);
    if(useGeo && lat && lng){
      p.set('lat', lat); p.set('lng', lng);
      if(radius) p.set('radius_km', radius);
    }
    const r=await fetch(`${base}/api/v1/offers?${p.toString()}`);
    return r.ok ? r.json() : [];
  }

  let data=await fetchOffers(true);
  if(Array.isArray(data) && data.length===0 && lat && lng){
    // –§–æ–ª–±—ç–∫ –±–µ–∑ –≥–µ–æ, —á—Ç–æ–±—ã —Å–ø–∏—Å–æ–∫ –Ω–µ –ø—Ä–æ–ø–∞–¥–∞–ª
    data=await fetchOffers(false);
  }

  const list=document.getElementById('list'); list.innerHTML='';
  if(!Array.isArray(data)||data.length===0){
    list.innerHTML='<div class="card muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ (–ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å –≥–µ–æ/—Ä–∞–¥–∏—É—Å)</div>'; return;
  }
  data.forEach(o=>{
    const left=o.qty_left; const exp=new Date(o.expires_at);
    const mins=Math.max(0, Math.floor((exp-new Date())/60000));
    const dist=o.distance_km!=null?` ¬∑ ${o.distance_km} –∫–º`:"";
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`<div class="row">
      <div class="col"><h3>${o.title}</h3>
        <div class="muted small">${o.restaurant_title||o.restaurant_id}${dist}</div>
        <div class="muted small">–î–æ —Å–ø–∏—Å–∞–Ω–∏—è: <b>${mins} –º–∏–Ω</b></div>
        <div class="small">–¶–µ–Ω–∞ —Å–µ–π—á–∞—Å: <span class="badge">${priceFmt(o.price_now_cents)}</span> <span class="muted">(–æ–±—ã—á–Ω–æ ${priceFmt(o.price_cents)})</span></div>
        <div class="small">–û—Å—Ç–∞–ª–æ—Å—å: <b>${left}</b></div>
      </div>
      <div style="display:flex;align-items:center;gap:8px"><button data-id="${o.id}" class="btn">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
    </div>`;
    div.querySelector('button').onclick=()=>reserve(o.id);
    list.appendChild(div);
  });
}

async function reserve(offerId){
  const base=window.BACKEND_PUBLIC;
  const tgid=window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 'demo';
  const r=await fetch(`${base}/api/v1/reservations`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({offer_id:offerId, buyer_tg_id:String(tgid)})
  });
  if(!r.ok){toast('–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏');return;}
  const data=await r.json();
  location.assign(`/web/buyer/receipt.html?id=${encodeURIComponent(data.id)}`);
}

document.getElementById('btnLoad').onclick=loadOffers;
document.getElementById('btnGeo').onclick=()=>{
  navigator.geolocation.getCurrentPosition(pos=>{
    document.getElementById('lat').value=pos.coords.latitude.toFixed(6);
    document.getElementById('lng').value=pos.coords.longitude.toFixed(6);
    if(!document.getElementById('radius').value) document.getElementById('radius').value='3';
    saveFilters(); loadOffers();
  },err=>toast('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'));
};
document.getElementById('city').onchange=(e)=>{
  const v=e.target.value;
  if(v){ const [la,ln]=v.split(','); document.getElementById('lat').value=la; document.getElementById('lng').value=ln; }
};
document.getElementById('btnSave').onclick=saveFilters;
window.addEventListener('load', ()=>{ loadFilters(); loadOffers(); });
</script>
</body></html>