<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Foody ‚Äî –õ–ö –ø–∞—Ä—Ç–Ω—ë—Ä–∞</title><link rel="stylesheet" href="/web/style.css"/>
<script src="https://telegram.org/js/telegram-web-app.js"></script><script src="/config.js"></script></head><body>
<div class="container">
  <h2>üë®‚Äçüç≥ –õ–ö –ø–∞—Ä—Ç–Ω—ë—Ä–∞</h2>

  <div class="card">
    <div class="row">
      <div class="col"><label class="small">Restaurant ID</label><input id="rid" class="input" placeholder="RID_..."/></div>
      <div class="col"><label class="small">API Key</label><input id="apikey" class="input" placeholder="–≤–∞—à –∫–ª—é—á"/></div>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btnSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn secondary" id="btnRegister">+ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</button>
      <a class="link" href="/web/staff/" target="_blank">–¢–∞–±–ª–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—É ‚Üí</a>
    </div>
  </div>

  <div class="card">
    <h3>–ù–æ–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</h3>
    <div class="row">
      <div class="col"><input id="title" class="input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/></div>
      <div class="col"><input id="priceRub" class="input" placeholder="–¶–µ–Ω–∞, ‚ÇΩ" inputmode="decimal"/></div>
    </div>
    <div class="row">
      <div class="col"><input id="qty_total" class="input" placeholder="–í—Å–µ–≥–æ –µ–¥." inputmode="numeric"/></div>
      <div class="col"><input id="qty_left" class="input" placeholder="–û—Å—Ç–∞–ª–æ—Å—å (–æ–ø—Ü.)" inputmode="numeric"/></div>
      <div class="col"><input id="expires" type="datetime-local" class="input" placeholder="–°—Ä–æ–∫ (–ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è)"/></div>
    </div>
    <div class="muted small" id="tzHint"></div>
    <div style="margin-top:8px"><button class="btn" id="btnCreate">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
  </div>

  <div class="card">
    <div class="row" style="align-items:center">
      <div class="col"><h3>–ú–æ–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h3></div>
      <div style="display:flex;gap:8px">
        <button class="btn secondary" id="btnLoad">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn secondary" id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
      </div>
    </div>
    <div id="table"></div>
  </div>
</div>

<div id="toast" class="toast"></div>
<script>
const tg=window.Telegram?.WebApp;if(tg){tg.expand();tg.setHeaderColor('#ffffff');tg.setBackgroundColor('#ffffff');}
const toast=(t)=>{const el=document.getElementById('toast');el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1500)};
const api=()=>window.BACKEND_PUBLIC; const rid=()=>document.getElementById('rid').value.trim(); const key=()=>document.getElementById('apikey').value.trim();
function saveProfile(){localStorage.setItem('foody_restaurant', JSON.stringify({id: rid()})); localStorage.setItem('api_key', key()); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');}
function loadProfile(){const r=JSON.parse(localStorage.getItem('foody_restaurant')||'{}'); if(r.id) document.getElementById('rid').value=r.id; const k=localStorage.getItem('api_key'); if(k) document.getElementById('apikey').value=k;}

function rubToCents(r){ const n=parseFloat(String(r).replace(',','.')); return Math.round((isNaN(n)?0:n)*100); }
function centsToRub(c){ return (c/100).toFixed(2).replace('.',','); }

function localToUtcIsoZ(localStr){ const d=new Date(localStr); return d.toISOString().replace(/\.\d{3}Z$/,'Z'); }
function setDefaultExpires(){ const d=new Date(Date.now()+2*3600*1000); const pad=n=>String(n).padStart(2,'0'); const local=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; document.getElementById('expires').value=local; document.getElementById('tzHint').textContent='–í–∞—à —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å: '+Intl.DateTimeFormat().resolvedOptions().timeZone+' ‚Äî –≤—Ä–µ–º—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ UTC –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏'; }

async function registerRestaurant(){
  const title=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞?'); if(!title) return;
  const lat=prompt('–®–∏—Ä–æ—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)');
  const lng=prompt('–î–æ–ª–≥–æ—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)');
  const body={title:title.trim()}; if(lat) body.lat=parseFloat(lat); if(lng) body.lng=parseFloat(lng);
  const r=await fetch(`${api()}/api/v1/auth/register_restaurant`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
  const data=await r.json();
  if(!r.ok){toast('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏'); console.log(data); return;}
  document.getElementById('rid').value=data.restaurant_id; document.getElementById('apikey').value=data.api_key; saveProfile(); toast('–†–µ—Å—Ç–æ—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω');
  await loadOffers();
}

async function createOffer(){
  if(!rid() || !key()){ toast('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ RID –∏ API Key'); return; }
  const local = document.getElementById('expires').value.trim(); if(!local){ toast('–£–∫–∞–∂–∏ —Å—Ä–æ–∫'); return; }
  const exp = localToUtcIsoZ(local);
  const body={restaurant_id:rid(), title:document.getElementById('title').value.trim(), price_cents:rubToCents(document.getElementById('priceRub').value), qty_total:parseInt(document.getElementById('qty_total').value.trim()||'1'), expires_at:exp};
  const ql=document.getElementById('qty_left').value.trim(); if(ql) body.qty_left=parseInt(ql);
  const r=await fetch(`${api()}/api/v1/merchant/offers`, {method:'POST', headers:{'Content-Type':'application/json','X-Foody-Key': key()}, body:JSON.stringify(body)});
  if(!r.ok){ const txt=await r.text(); toast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: '+txt.slice(0,160)); return; } toast('–°–æ–∑–¥–∞–Ω–æ'); loadOffers();
}

async function loadOffers(){
  const r=await fetch(`${api()}/api/v1/merchant/offers?restaurant_id=${encodeURIComponent(rid())}`, {headers:{'X-Foody-Key': key()}});
  const data=await r.json();
  const el=document.getElementById('table');
  if(!Array.isArray(data)||data.length===0){el.innerHTML='<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>'; return;}
  el.innerHTML='<table class="table"><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¶–µ–Ω–∞</th><th>–û—Å—Ç.</th><th>–°—Ä–æ–∫</th><th></th></tr></thead><tbody>'+
    data.map(x=>`<tr data-id="${x.id}"><td>${x.title}</td><td>${centsToRub(x.price_cents)} ‚ÇΩ</td><td>${x.qty_left}/${x.qty_total}</td><td>${new Date(x.expires_at).toLocaleString()}</td><td><button class="btn tiny edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button> <button class="btn tiny danger del">–£–¥–∞–ª–∏—Ç—å</button></td></tr>`).join('')+
  '</tbody></table>';
  el.querySelectorAll('.del').forEach(btn=>btn.onclick=()=>delOffer(btn.closest('tr').getAttribute('data-id')));
  el.querySelectorAll('.edit').forEach(btn=>btn.onclick=()=>editOffer(btn.closest('tr').getAttribute('data-id')));
}

async function delOffer(id){
  const r=await fetch(`${api()}/api/v1/merchant/offers/${encodeURIComponent(id)}`, {method:'DELETE', headers:{'X-Foody-Key': key()}});
  const txt=await r.text();
  if(!r.ok){toast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: '+txt.slice(0,160)); return;} toast('–£–¥–∞–ª–µ–Ω–æ'); loadOffers();
}

async function editOffer(id){
  const title=prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–ø—É—Å—Ç–æ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)');
  const price=prompt('–ù–æ–≤–∞—è —Ü–µ–Ω–∞, ‚ÇΩ (–ø—É—Å—Ç–æ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)');
  const qty_total=prompt('–í—Å–µ–≥–æ –µ–¥. (–ø—É—Å—Ç–æ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)');
  const qty_left=prompt('–û—Å—Ç–∞–ª–æ—Å—å (–ø—É—Å—Ç–æ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)');
  const expLocal=prompt('–ù–æ–≤—ã–π —Å—Ä–æ–∫ (YYYY-MM-DDTHH:MM ‚Äî –ª–æ–∫–∞–ª—å–Ω–æ, –ø—É—Å—Ç–æ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)');
  const body={};
  if(title) body.title=title.trim();
  if(price) body.price_cents=Math.round(parseFloat(String(price).replace(',','.'))*100);
  if(qty_total) body.qty_total=parseInt(qty_total);
  if(qty_left) body.qty_left=parseInt(qty_left);
  if(expLocal) body.expires_at=new Date(expLocal).toISOString().replace(/\.\d{3}Z$/,'Z');
  if(Object.keys(body).length===0){ toast('–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π'); return; }
  const r=await fetch(`${api()}/api/v1/merchant/offers/${encodeURIComponent(id)}`, {method:'PATCH', headers:{'Content-Type':'application/json','X-Foody-Key': key()}, body:JSON.stringify(body)});
  const txt=await r.text();
  if(!r.ok){toast('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è: '+txt.slice(0,160)); return;} toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); loadOffers();
}

async function exportCsv(){
  try{
    const r=await fetch(`${api()}/api/v1/merchant/report.csv?restaurant_id=${encodeURIComponent(rid())}`, {headers:{'X-Foody-Key': key()}});
    if(!r.ok){ toast('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞'); return; }
    const txt=await r.text();
    try{ await navigator.clipboard.writeText(txt); toast('CSV —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä'); }catch(_){ /* ignore */ }
    const blob=new Blob([txt], {type:'text/csv;charset=utf-8'});
    const href=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=href; a.download=`foody_report_${rid()}.csv`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(href), 1000);
  }catch(e){ toast('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–≥—Ä—É–∑–∏—Ç—å CSV'); }
}

document.getElementById('btnSave').onclick=()=>{saveProfile(); loadOffers();};
document.getElementById('btnRegister').onclick=registerRestaurant;
document.getElementById('btnCreate').onclick=createOffer;
document.getElementById('btnLoad').onclick=loadOffers;
document.getElementById('btnExport').onclick=exportCsv;

window.addEventListener('load', async ()=>{
  loadProfile();
  const d=new Date(Date.now()+2*3600*1000); const pad=n=>String(n).padStart(2,'0'); const local=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; document.getElementById('expires').value=local;
});
</script>
</body></html>