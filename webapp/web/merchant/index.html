<!doctype html><html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Foody ‚Äî –õ–ö –ø–∞—Ä—Ç–Ω—ë—Ä–∞</title>
<link rel="stylesheet" href="/web/style.css"/>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="/config.js"></script>
</head><body>
<div class="container">
  <h2>üë®‚Äçüç≥ –õ–ö –ø–∞—Ä—Ç–Ω—ë—Ä–∞</h2>
  <div class="card">
    <div class="row">
      <div class="col"><label class="small">Restaurant ID</label><input id="rid" class="input" placeholder="RID_DEMO"/></div>
      <div class="col"><label class="small">API Key</label><input id="apikey" class="input" placeholder="–≤–∞—à –∫–ª—é—á"/></div>
    </div>
    <div style="margin-top:8px">
      <button class="btn" id="btnSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <span class="small muted">–ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª –Ω–∏–∂–µ</span>
    </div>
  </div>

  <div class="card">
    <h3>–ù–æ–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</h3>
    <div class="row">
      <div class="col"><input id="title" class="input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/></div>
      <div class="col"><input id="price" class="input" placeholder="–¶–µ–Ω–∞ –≤ –∫–æ–ø–µ–π–∫–∞—Ö (–Ω–∞–ø—Ä. 19900)"/></div>
    </div>
    <div class="row">
      <div class="col"><input id="qty_total" class="input" placeholder="–í—Å–µ–≥–æ –µ–¥. (–Ω–∞–ø—Ä. 10)"/></div>
      <div class="col"><input id="qty_left" class="input" placeholder="–û—Å—Ç–∞–ª–æ—Å—å (–æ–ø—Ü.)"/></div>
      <div class="col"><input id="expires" class="input" placeholder="–ì–ì–ì–ì-–ú–ú-–î–î–ß–ß:–ú–úZ (UTC)"/></div>
    </div>
    <div style="margin-top:8px"><button class="btn" id="btnCreate">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
  </div>

  <div class="card">
    <div class="row" style="align-items:center">
      <div class="col"><h3>–ú–æ–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h3></div>
      <div><button class="btn secondary" id="btnLoad">–û–±–Ω–æ–≤–∏—Ç—å</button></div>
    </div>
    <div id="table"></div>
  </div>

  <div class="card">
    <h3>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h3>
    <div class="small">BACKEND_PUBLIC: <b id="conf"></b></div>
    <div style="margin-top:8px"><button class="btn" id="btnCheck">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button></div>
    <pre id="checkOut" class="small" style="white-space:pre-wrap;background:#f7f7fb;padding:10px;border-radius:12px;border:1px solid #e5e7eb;margin-top:8px"></pre>
  </div>
</div>

<div id="toast" class="toast"></div>
<script>
const tg = window.Telegram?.WebApp; if(tg){tg.expand();tg.setHeaderColor('#ffffff');tg.setBackgroundColor('#ffffff');}
const toast=(t)=>{const el=document.getElementById('toast');el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1500)};
const api = ()=> window.BACKEND_PUBLIC;
const rid = ()=> document.getElementById('rid').value.trim();
const key = ()=> document.getElementById('apikey').value.trim();

function saveProfile(){
  localStorage.setItem('foody_restaurant', JSON.stringify({id: rid()}));
  localStorage.setItem('api_key', key());
  toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
}
function loadProfile(){
  const r = JSON.parse(localStorage.getItem('foody_restaurant')||'{}');
  if(r.id) document.getElementById('rid').value = r.id;
  const k = localStorage.getItem('api_key'); if(k) document.getElementById('apikey').value = k;
  document.getElementById('conf').textContent = api();
}
async function checkProfile(){
  const r = await fetch(`${api()}/api/v1/merchant/offers?restaurant_id=${encodeURIComponent(rid())}`, {headers:{'X-Foody-Key': key()}});
  document.getElementById('checkOut').textContent = `GET /merchant/offers ‚Üí ${r.status}\n` + await r.text();
}
async function createOffer(){
  const body = {
    restaurant_id: rid(),
    title: document.getElementById('title').value.trim(),
    price_cents: parseInt(document.getElementById('price').value.trim()||'0'),
    qty_total: parseInt(document.getElementById('qty_total').value.trim()||'1'),
    qty_left: parseInt(document.getElementById('qty_left').value.trim()||'0') || undefined,
    expires_at: document.getElementById('expires').value.trim()
  };
  const r = await fetch(`${api()}/api/v1/merchant/offers`, {
    method:'POST', headers:{'Content-Type':'application/json', 'X-Foody-Key': key()}, body: JSON.stringify(body)
  });
  if(!r.ok){ toast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è'); return; }
  toast('–°–æ–∑–¥–∞–Ω–æ'); loadOffers();
}
async function loadOffers(){
  const r = await fetch(`${api()}/api/v1/merchant/offers?restaurant_id=${encodeURIComponent(rid())}`, {headers:{'X-Foody-Key': key()}});
  const data = await r.json();
  const el = document.getElementById('table');
  if(!Array.isArray(data)||data.length===0){ el.innerHTML='<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>'; return; }
  el.innerHTML = '<table class="table"><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¶–µ–Ω–∞</th><th>–û—Å—Ç.</th><th>–°—Ä–æ–∫</th><th></th></tr></thead><tbody>'+
    data.map(x=>`<tr><td>${x.title}</td><td>${(x.price_cents/100).toFixed(2).replace('.',',')} ‚ÇΩ</td><td>${x.qty_left}/${x.qty_total}</td><td>${new Date(x.expires_at).toLocaleString()}</td><td><button class="btn" data-id="${x.id}">–£–¥–∞–ª–∏—Ç—å</button></td></tr>`).join('')+
  '</tbody></table>';
  el.querySelectorAll('button[data-id]').forEach(btn=>btn.onclick=()=>delOffer(btn.getAttribute('data-id')));
}
async function delOffer(id){
  const r = await fetch(`${api()}/api/v1/merchant/offers/${encodeURIComponent(id)}`, {method:'DELETE', headers:{'X-Foody-Key': key()}});
  if(!r.ok){ toast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); return; }
  toast('–£–¥–∞–ª–µ–Ω–æ'); loadOffers();
}

document.getElementById('btnSave').onclick=()=>{saveProfile(); loadOffers();};
document.getElementById('btnCreate').onclick=createOffer;
document.getElementById('btnLoad').onclick=loadOffers;
document.getElementById('btnCheck').onclick=checkProfile;
window.addEventListener('load', ()=>{ loadProfile(); });
</script>
</body></html>
