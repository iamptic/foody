<!doctype html>
<html><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Foody — Предложения рядом</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="/config.js"></script>
  <style>
:root{
  --bg: #f7f7fb;
  --text: #12141a;
  --subtle: #6b7280;
  --card: #ffffff;
  --border: #e6e7ee;
  --accent: #6b5cff;
  --accent-text: #ffffff;
  --danger: #e11d48;
  --ok: #10b981;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; padding:16px;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;
  color:var(--text); background:var(--bg);
}
h1,h2,h3{margin:0 0 12px}
.container{max-width:920px;margin:0 auto}
.section{margin:16px 0}
.card{
  background:var(--card); border:1px solid var(--border);
  border-radius:16px; padding:16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}
.row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
.input, select, textarea{
  width:100%; background:#fff; color:var(--text);
  border:1px solid var(--border); border-radius:12px; padding:10px 12px;
}
label{font-size:13px; color:var(--subtle); display:block; margin:6px 0}
.btn{
  display:inline-flex; align-items:center; justify-content:center; gap:8px;
  padding:10px 14px; border-radius:12px; border:1px solid var(--border);
  background:var(--accent); color:var(--accent-text); cursor:pointer;
}
.btn.ghost{ background:#fff; color:var(--text) }
.btn.secondary{ background:#eef2ff }
.badge{padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--subtle);background:#fff}
.grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:12px}
.card-item{border-radius:14px; border:1px solid var(--border); background:#fff; padding:12px}
.card-item h3{font-size:16px; margin:0 0 4px}
.empty{opacity:0.7; text-align:center; padding:24px 8px}
.table{width:100%; border-collapse:collapse}
.table th,.table td{padding:10px 8px; border-bottom:1px solid var(--border); font-size:14px}
.small{font-size:12px; color:var(--subtle)}
hr{border:none; border-top:1px solid var(--border); margin:12px 0}
</style>
</head>
<body>
<div class="container">
  <h1>Foody</h1>
  <div class="section card">
    <div class="row">
      <h2 style="flex:1">Предложения рядом</h2>
      <select id="sort" class="input" style="max-width:220px">
        <option value="new">Сначала новые</option>
        <option value="cheap">Сначала дешевле</option>
        <option value="exp">Скоро истекают</option>
      </select>
    </div>
    <div id="offers" class="grid"></div>
    <div id="empty" class="empty" style="display:none">Пока ничего нет. Загляните чуть позже.</div>
  </div>
</div>

<script type="module">
  (function(){const tg=window.Telegram&&window.Telegram.WebApp;if(!tg)return;try{tg.ready();tg.expand();}catch(e){}})();
  const api = window.BACKEND_PUBLIC || location.origin;
  const state = { offers:[] };

  function asRub(c){return (c/100).toFixed(2)+' ₽'}
  function card(o){
    return `<div class="card-item">
      <h3>${o.title}</h3>
      <div class="row"><div class="badge">до ${new Date(o.expires_at).toLocaleTimeString()}</div><div class="badge">остаток: ${o.qty_left}</div></div>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <div><b>${asRub(o.price_now_cents)}</b> <span class="small">от ${asRub(o.price_cents)}</span></div>
        <button class="btn" data-id="${o.id}">Забронировать</button>
      </div>
    </div>`
  }

  function render(){
    const root = document.getElementById('offers');
    root.innerHTML = state.offers.map(card).join('');
    document.getElementById('empty').style.display = state.offers.length ? 'none':'block';
    root.querySelectorAll('button.btn').forEach(b=>b.onclick = ()=>book(b.dataset.id));
  }

  function sortApply(){
    const s = document.getElementById('sort').value;
    if(s==='cheap') state.offers.sort((a,b)=>a.price_now_cents-b.price_now_cents);
    else if(s==='exp') state.offers.sort((a,b)=> new Date(a.expires_at)-new Date(b.expires_at));
    else state.offers.sort((a,b)=> new Date(b.expires_at)-new Date(a.expires_at));
  }

  async function load(){
    const rid = 'RID_DEMO';
    const r = await fetch(`${api}/api/v1/offers?restaurant_id=${encodeURIComponent(rid)}`);
    state.offers = await r.json();
    sortApply(); render();
  }
  document.getElementById('sort').onchange = ()=>{ sortApply(); render(); }
  load().catch(console.error);

  async function book(id){
    const tg = (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe) || {}
    const buyerId = tg.user?.id || 'guest';
    const r = await fetch(`${api}/api/v1/reservations`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({offer_id:id, buyer_tg_id:String(buyerId)})
    });
    if(!r.ok){ alert('Ошибка бронирования'); return; }
    const res = await r.json();
    location.href = `buyer/receipt.html?id=${encodeURIComponent(res.id)}&code=${encodeURIComponent(res.code)}`;
  }
</script>
</body></html>
