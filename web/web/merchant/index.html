<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Foody ‚Äî –ü–∞—Ä—Ç–Ω—ë—Ä–∞–º</title><link rel="stylesheet" href="/web/style.css"/>
<script src="https://telegram.org/js/telegram-web-app.js">
async function registerRestaurant(){
  const name = (document.getElementById('name')?.value||'').trim();
  const phone = (document.getElementById('phone')?.value||'').trim();
  if(!name){ toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è'); return; }
  const url1 = api()+"/api/v1/merchant/register_public";
  const url2 = api()+"/api/v1/merchant/register";
  const body = { title: name, phone: phone||undefined };
  try{
    let r = await fetch(url1,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(r.status===404 || r.status===405){ r = await fetch(url2,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); }
    const t = await r.text();
    if(!r.ok){ toast('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: '+t.slice(0,140)); return; }
    const data = JSON.parse(t);
    if(!data.restaurant_id || !data.api_key){ toast('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: '+t.slice(0,140)); return; }
    document.getElementById('rid').value = data.restaurant_id;
    document.getElementById('apikey').value = data.api_key;
    saveProfile();
    toast('–ì–æ—Ç–æ–≤–æ! RID –∏ –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
  }catch(e){
    toast('–°–µ—Ç—å/–æ—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏'); console.error(e);
  }
}
document.getElementById('copyRid').onclick=()=>{ const v=document.getElementById('rid').value; navigator.clipboard.writeText(v||''); toast('RID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'); };
document.getElementById('copyKey').onclick=()=>{ const v=document.getElementById('apikey').value; navigator.clipboard.writeText(v||''); toast('API –∫–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'); };

function hideEditColumnIfEmpty(arr){
  const th = document.querySelector('.thEdit');
  if(!th) return;
  if(!Array.isArray(arr) || arr.length===0){ th.style.display='none'; } else { th.style.display=''; }
}

function _num(v){ return parseFloat((v||'').toString().replace(',','.'))||0; }
function _setPriceRub(r){ const el=document.getElementById('price'); el.value = (Math.round((r||0)*100)/100).toFixed(2).replace('.',','); }
function _setExpirePlusHours(h){
  const input=document.getElementById('expires');
  const base = input.value ? new Date(input.value) : new Date();
  base.setHours(base.getHours() + h);
  const pad=n=>String(n).padStart(2,'0');
  input.value = base.getFullYear()+'-'+pad(base.getMonth()+1)+'-'+pad(base.getDate())+'T'+pad(base.getHours())+':'+pad(base.getMinutes());
}
document.getElementById('btnPreset30').onclick=()=>{ const p=_num(document.getElementById('price').value); if(p>0) _setPriceRub(p*0.7); };
document.getElementById('btnPreset50').onclick=()=>{ const p=_num(document.getElementById('price').value); if(p>0) _setPriceRub(p*0.5); };
document.getElementById('btnPreset70').onclick=()=>{ const p=_num(document.getElementById('price').value); if(p>0) _setPriceRub(p*0.3); };
document.getElementById('btnPlus1h').onclick=()=>_setExpirePlusHours(1);
document.getElementById('btnPlus2h').onclick=()=>_setExpirePlusHours(2);
</script><script src="/config.js">
async function registerRestaurant(){
  const name = (document.getElementById('name')?.value||'').trim();
  const phone = (document.getElementById('phone')?.value||'').trim();
  if(!name){ toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è'); return; }
  const url1 = api()+"/api/v1/merchant/register_public";
  const url2 = api()+"/api/v1/merchant/register";
  const body = { title: name, phone: phone||undefined };
  try{
    let r = await fetch(url1,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(r.status===404 || r.status===405){ r = await fetch(url2,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); }
    const t = await r.text();
    if(!r.ok){ toast('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: '+t.slice(0,140)); return; }
    const data = JSON.parse(t);
    if(!data.restaurant_id || !data.api_key){ toast('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: '+t.slice(0,140)); return; }
    document.getElementById('rid').value = data.restaurant_id;
    document.getElementById('apikey').value = data.api_key;
    saveProfile();
    toast('–ì–æ—Ç–æ–≤–æ! RID –∏ –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
  }catch(e){
    toast('–°–µ—Ç—å/–æ—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏'); console.error(e);
  }
}
document.getElementById('copyRid').onclick=()=>{ const v=document.getElementById('rid').value; navigator.clipboard.writeText(v||''); toast('RID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'); };
document.getElementById('copyKey').onclick=()=>{ const v=document.getElementById('apikey').value; navigator.clipboard.writeText(v||''); toast('API –∫–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'); };

function hideEditColumnIfEmpty(arr){
  const th = document.querySelector('.thEdit');
  if(!th) return;
  if(!Array.isArray(arr) || arr.length===0){ th.style.display='none'; } else { th.style.display=''; }
}

function _num(v){ return parseFloat((v||'').toString().replace(',','.'))||0; }
function _setPriceRub(r){ const el=document.getElementById('price'); el.value = (Math.round((r||0)*100)/100).toFixed(2).replace('.',','); }
function _setExpirePlusHours(h){
  const input=document.getElementById('expires');
  const base = input.value ? new Date(input.value) : new Date();
  base.setHours(base.getHours() + h);
  const pad=n=>String(n).padStart(2,'0');
  input.value = base.getFullYear()+'-'+pad(base.getMonth()+1)+'-'+pad(base.getDate())+'T'+pad(base.getHours())+':'+pad(base.getMinutes());
}
document.getElementById('btnPreset30').onclick=()=>{ const p=_num(document.getElementById('price').value); if(p>0) _setPriceRub(p*0.7); };
document.getElementById('btnPreset50').onclick=()=>{ const p=_num(document.getElementById('price').value); if(p>0) _setPriceRub(p*0.5); };
document.getElementById('btnPreset70').onclick=()=>{ const p=_num(document.getElementById('price').value); if(p>0) _setPriceRub(p*0.3); };
document.getElementById('btnPlus1h').onclick=()=>_setExpirePlusHours(1);
document.getElementById('btnPlus2h').onclick=()=>_setExpirePlusHours(2);
</script></head><body>
<div class="container">
  <h2>üë®‚Äçüç≥ –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –∫–∞–±–∏–Ω–µ—Ç</h2>

  <details class="card"><summary><b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b> (RID/API Key)</summary>
    <div class="row" style="margin-top:8px">
      <div class="col"><label class="small">Restaurant ID</label><input id="rid" class="input" style="width:calc(100% - 86px);display:inline-block" placeholder="RID_..."/></div>
      <div class="col"><label class="small">API Key</label><input id="apikey" class="input" style="width:calc(100% - 86px);display:inline-block" placeholder="–≤–∞—à –∫–ª—é—á"/></div>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btnSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn secondary" id="btnRegister">+ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω</button>
      <a class="link" href="/web/staff/" target="_blank">–¢–∞–±–ª–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—É ‚Üí</a>
    </div>
  </details>

  <div class="card">
    <h3>–ù–æ–≤–æ–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h3>
    '; return;}
  el.innerHTML='<table class="table"><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¶–µ–Ω–∞</th><th>–û—Å—Ç.</th><th>–°—Ä–æ–∫</th><th></th><th class=\"thEdit\"></th></tr></thead><tbody>'+
    data.map(x=>`<tr><td>${x.title}</td><td>${fmtRub(x.price_cents)}</td><td>${x.qty_left}/${x.qty_total}</td><td>${new Date(x.expires_at).toLocaleString()}</td><td><button class="btn" data-act="edit" data-id="${x.id}">–ò–∑–º.</button> <button class="btn secondary" data-act="del" data-id="${x.id}">–£–¥–∞–ª–∏—Ç—å</button></td></tr>`).join('')+
  '</tbody></table>';
  el.querySelectorAll('button[data-act="del"]').forEach(btn=>btn.onclick=()=>delOffer(btn.getAttribute('data-id')));
  el.querySelectorAll('button[data-act="edit"]').forEach(btn=>btn.onclick=()=>prefill(btn.getAttribute('data-id'), data));
}

function prefill(id, data){
  const x=data.find(o=>o.id===id); if(!x) return;
  editingId=id;
  document.getElementById('title').value=x.title;
  document.getElementById('price_rub').value=(x.price_cents/100).toFixed(2).replace('.',',');
  document.getElementById('qty_total').value=x.qty_total;
  document.getElementById('qty_left').value=x.qty_left;
  const d=new Date(x.expires_at); const pad=n=>String(n).padStart(2,'0');
  document.getElementById('expires').value=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  toast('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
}

async function delOffer(id){
  const url = `${api()}/api/v1/merchant/offers/${encodeURIComponent(id)}?restaurant_id=${encodeURIComponent(rid())}`;
  const r=await fetch(url, {method:'DELETE', headers:{'X-Foody-Key': key()}});
  const txt=await r.text();
  if(!r.ok){toast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: '+txt.slice(0,160)); return;} toast('–£–¥–∞–ª–µ–Ω–æ'); loadOffers();
}

async function exportCsv(){
  const url=`${api()}/api/v1/merchant/report.csv?restaurant_id=${encodeURIComponent(rid())}`;
  try{
    const r=await fetch(url, {headers:{'X-Foody-Key': key()}});
    if(!r.ok){ toast('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞'); return; }
    const blob=await r.blob();
    const href=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=href; a.download=`foody_report_${rid()}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(href), 1000);
    // –¥—É–±–ª—å ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–∫ data URL
    const reader=new FileReader();
    reader.onload=()=>{ const dataUrl=reader.result; if(window.Telegram?.WebApp?.openLink){ try{ window.Telegram.WebApp.openLink(dataUrl); }catch(_){} } };
    reader.readAsDataURL(blob);
    toast('CSV –≤—ã–≥—Ä—É–∂–µ–Ω');
  }catch(e){
    try{ const t=await (await fetch(url,{headers:{'X-Foody-Key': key()}})).text();
      const w=window.open('','_blank'); if(w){ w.document.body.innerHTML='<pre>'+t.replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]))+'</pre>'; }
    }catch(_){ toast('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–≥—Ä—É–∑–∏—Ç—å CSV'); }
  }
}

document.getElementById('btnSave').onclick=()=>{saveProfile(); loadOffers();};
document.getElementById('btnRegister').onclick=registerRestaurant;
document.getElementById('btnCreate').onclick=submitForm;
document.getElementById('btnReset').onclick=resetForm;
document.getElementById('btnLoad').onclick=loadOffers;
document.getElementById('csvCopy').onclick=()=>{ const t=document.getElementById('csvText'); t.select(); document.execCommand('copy'); toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); };
document.getElementById('csvClose').onclick=()=>document.getElementById('csvModal').classList.add('hidden');


window.addEventListener('load', async ()=>{
  loadProfile(); setDefaultExpires(); await loadOffers();
});
document.getElementById('rid').addEventListener('change', saveProfile);
document.getElementById('apikey').addEventListener('change', saveProfile);

let currentEditId=null;
function openEdit(id){
  currentEditId=id;
  const row = Array.from(document.querySelectorAll('button[data-edit]')).find(b=>b.getAttribute('data-edit')===id).closest('tr').children;
  document.getElementById('e_title').value = row[0].textContent.trim();
  document.getElementById('e_price').value = row[1].textContent.replace(' ‚ÇΩ','').replace(',','.');
  const leftTotal = row[2].textContent.split('/'); 
  document.getElementById('e_qty_left').value = (leftTotal[0]||'').trim();
  document.getElementById('e_qty_total').value = (leftTotal[1]||'').trim();
  const dt = new Date(row[3].textContent); const pad=n=>String(n).padStart(2,'0');
  const local = `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}T${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
  document.getElementById('e_expires').value = local;
  document.getElementById('editModal').classList.remove('hidden');
}
document.getElementById('e_cancel').onclick=()=>document.getElementById('editModal').classList.add('hidden');
document.getElementById('e_save').onclick=async()=>{
  if(!currentEditId) return;
  const local = document.getElementById('e_expires').value.trim();
  const exp = local ? new Date(local).toISOString().replace(/\.\d{3}Z$/,'Z') : null;
  const priceRub=parseFloat((document.getElementById('e_price').value||'0').replace(',','.'))||0;
  const body = {
    restaurant_id: rid(),
    title: document.getElementById('e_title').value.trim() || undefined,
    price_cents: Math.round(priceRub*100),
    qty_total: parseInt(document.getElementById('e_qty_total').value||'0') || undefined,
    qty_left: parseInt(document.getElementById('e_qty_left').value||'0'),
    expires_at: exp
  };
  const r=await fetch(`${api()}/api/v1/merchant/offers/${encodeURIComponent(currentEditId)}`, {method:'PATCH', headers:{'Content-Type':'application/json','X-Foody-Key': key()}, body: JSON.stringify(body)});
  const ok=r.ok; const txt=await r.text();
  if(ok){ toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); document.getElementById('editModal').classList.add('hidden'); loadOffers(); } else { toast('–û—à–∏–±–∫–∞: '+txt.slice(0,160)); }
};


async function registerRestaurant(){
  const name = (document.getElementById('name')?.value||'').trim();
  const phone = (document.getElementById('phone')?.value||'').trim();
  if(!name){ toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è'); return; }
  const url1 = api()+"/api/v1/merchant/register_public";
  const url2 = api()+"/api/v1/merchant/register";
  const body = { title: name, phone: phone||undefined };
  try{
    let r = await fetch(url1,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(r.status===404 || r.status===405){ r = await fetch(url2,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); }
    const t = await r.text();
    if(!r.ok){ toast('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: '+t.slice(0,140)); return; }
    const data = JSON.parse(t);
    if(!data.restaurant_id || !data.api_key){ toast('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: '+t.slice(0,140)); return; }
    document.getElementById('rid').value = data.restaurant_id;
    document.getElementById('apikey').value = data.api_key;
    saveProfile();
    toast('–ì–æ—Ç–æ–≤–æ! RID –∏ –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
  }catch(e){
    toast('–°–µ—Ç—å/–æ—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏'); console.error(e);
  }
}
document.getElementById('copyRid').onclick=()=>{ const v=document.getElementById('rid').value; navigator.clipboard.writeText(v||''); toast('RID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'); };
document.getElementById('copyKey').onclick=()=>{ const v=document.getElementById('apikey').value; navigator.clipboard.writeText(v||''); toast('API –∫–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'); };

function hideEditColumnIfEmpty(arr){
  const th = document.querySelector('.thEdit');
  if(!th) return;
  if(!Array.isArray(arr) || arr.length===0){ th.style.display='none'; } else { th.style.display=''; }
}

function _num(v){ return parseFloat((v||'').toString().replace(',','.'))||0; }
function _setPriceRub(r){ const el=document.getElementById('price'); el.value = (Math.round((r||0)*100)/100).toFixed(2).replace('.',','); }
function _setExpirePlusHours(h){
  const input=document.getElementById('expires');
  const base = input.value ? new Date(input.value) : new Date();
  base.setHours(base.getHours() + h);
  const pad=n=>String(n).padStart(2,'0');
  input.value = base.getFullYear()+'-'+pad(base.getMonth()+1)+'-'+pad(base.getDate())+'T'+pad(base.getHours())+':'+pad(base.getMinutes());
}
document.getElementById('btnPreset30').onclick=()=>{ const p=_num(document.getElementById('price').value); if(p>0) _setPriceRub(p*0.7); };
document.getElementById('btnPreset50').onclick=()=>{ const p=_num(document.getElementById('price').value); if(p>0) _setPriceRub(p*0.5); };
document.getElementById('btnPreset70').onclick=()=>{ const p=_num(document.getElementById('price').value); if(p>0) _setPriceRub(p*0.3); };
document.getElementById('btnPlus1h').onclick=()=>_setExpirePlusHours(1);
document.getElementById('btnPlus2h').onclick=()=>_setExpirePlusHours(2);
</script>
</body></html>
