<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Foody ‚Äî –í–∏—Ç—Ä–∏–Ω–∞</title><link rel="stylesheet" href="/web/style.css"/>
<script src="https://telegram.org/js/telegram-web-app.js">
const urlParams = new URLSearchParams(location.search);
const paramOffer = urlParams.get('offer');
function focusOffer(id){
  const card = document.querySelector(`[data-offer-id="${id}"]`);
  if(card){ card.scrollIntoView({behavior:'smooth',block:'center'}); card.classList.add('pulse'); setTimeout(()=>card.classList.remove('pulse'),2000); }
}
setTimeout(()=>{ if(paramOffer) focusOffer(paramOffer); }, 800);
</script><script src="/config.js">
const urlParams = new URLSearchParams(location.search);
const paramOffer = urlParams.get('offer');
function focusOffer(id){
  const card = document.querySelector(`[data-offer-id="${id}"]`);
  if(card){ card.scrollIntoView({behavior:'smooth',block:'center'}); card.classList.add('pulse'); setTimeout(()=>card.classList.remove('pulse'),2000); }
}
setTimeout(()=>{ if(paramOffer) focusOffer(paramOffer); }, 800);
</script></head><body>
<div class="container">
  <h2>üõí –í–∏—Ç—Ä–∏–Ω–∞</h2>
  <div class="card">
    <div class="row">
      <div class="col"><label class="small">–ì–æ—Ä–æ–¥</label>
        <select id="city" class="input">
          <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>
          <option value="55.7558,37.6176">–ú–æ—Å–∫–≤–∞</option>
          <option value="59.9343,30.3351">–°–∞–Ω–∫—Ç‚Äë–ü–µ—Ç–µ—Ä–±—É—Ä–≥</option>
          <option value="56.8389,60.6057">–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥</option>
          <option value="55.0302,82.9204">–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫</option>
          <option value="43.1176,131.899">–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫</option>
        </select>
      </div>
      <div class="col"><label class="small">–†–∞–¥–∏—É—Å, –∫–º</label><input id="radius" class="input" placeholder="3"/></div>
      <div class="col"><label class="small">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
        <select id="sort" class="input">
          <option value="time">–°–∫–æ—Ä–æ —Å–ø–∏—à–µ—Ç—Å—è</option>
          <option value="dist">–ë–ª–∏–∂–µ –∫ –≤–∞–º</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div class="col"><label class="small">Lat</label><input id="lat" class="input" placeholder="–∞–≤—Ç–æ"/></div>
      <div class="col"><label class="small">Lng</label><input id="lng" class="input" placeholder="–∞–≤—Ç–æ"/></div>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btnGeo">üìç –ú–æ—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è</button>
      <button class="btn" id="btnLoad">–û–±–Ω–æ–≤–∏—Ç—å</button>
      <button class="btn secondary" id="btnSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
    </div>
  </div>
  <div id="list"></div>
</div>
<div id="toast" class="toast"></div>
<script>
const toast=(t)=>{const el=document.getElementById('toast');el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1500)};
const tg=window.Telegram?.WebApp;if(tg){tg.expand();tg.setHeaderColor('#ffffff');tg.setBackgroundColor('#ffffff');}
const fmtRub = v => (Math.round(v)/100).toFixed(2).replace('.',',')+' ‚ÇΩ';

function saveFilters(){
  localStorage.setItem('foody_filters', JSON.stringify({
    lat: v('lat'), lng: v('lng'), radius: v('radius'), city: v('city'), sort: v('sort')
  })); toast('–§–∏–ª—å—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
}
function loadFilters(){
  try{const f=JSON.parse(localStorage.getItem('foody_filters')||'{}');
    if(f.city) s('city',f.city);
    if(f.lat) s('lat',f.lat);
    if(f.lng) s('lng',f.lng);
    if(f.radius) s('radius',f.radius);
    if(f.sort) s('sort',f.sort);
  }catch(_){}
}
const q = sel => document.querySelector(sel);
const v = id => document.getElementById(id).value.trim();
const s = (id,val)=>{document.getElementById(id).value=val};

let current = [];
let timerId=null;

function dynamicNow(price_cents, expires_at){
  // –ï—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –Ω–µ –¥–∞–ª price_now_cents ‚Äî —Å—á–∏—Ç–∞–µ–º —Å–∞–º–∏ –ª–∏–Ω–µ–π–Ω–æ:
  // –æ—Ç 100% ‚Üí –∫ 50% –∑–∞ 2 —á–∞—Å–∞ –¥–æ –∫–æ–Ω—Ü–∞ (–º–∏–Ω–∏–º—É–º 30% –æ—Ç –±–∞–∑–æ–≤–æ–π).
  const now = Date.now();
  const exp = new Date(expires_at).getTime();
  const mins = Math.max(0, Math.floor((exp - now)/60000));
  let k = 1.0;
  if(mins <= 120){
    k = Math.max(0.30, 0.5 + (mins/120)*0.5); // 0.5..1.0
  }
  return Math.round(price_cents * k);
}

function render(){
  const list=q('#list'); list.innerHTML='';
  if(current.length===0){ list.innerHTML='<div class="card muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>'; return; }
  const sort = v('sort');
  const arr = [...current];
  if(sort==='time'){
    arr.sort((a,b)=>new Date(a.expires_at)-new Date(b.expires_at));
  }else if(sort==='dist'){
    arr.sort((a,b)=>(a.distance_km??1e9)-(b.distance_km??1e9));
  }
  arr.forEach(o=>{
    const id='tm_'+o.id;
    const exp=new Date(o.expires_at);
    const mins=Math.max(0, Math.floor((exp-new Date())/60000));
    const dist=o.distance_km!=null?` ¬∑ ${o.distance_km} –∫–º`:"";
    const now_cents = (o.price_now_cents!=null)?o.price_now_cents:dynamicNow(o.price_cents, o.expires_at);
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`<div class="row">
      <div class="col"><h3>${o.title}</h3>
        <div class="muted small">${o.restaurant_title||o.restaurant_id}${dist}</div>
        <div class="muted small">–î–æ —Å–ø–∏—Å–∞–Ω–∏—è: <b id="${id}">${mins} –º–∏–Ω</b></div>
        <div class="small">–¶–µ–Ω–∞: <span class="badge">${fmtRub(now_cents)}</span>
          <span class="price-old">${fmtRub(o.price_cents)}</span>
        </div>
        <div class="small">–û—Å—Ç–∞–ª–æ—Å—å: <b>${o.qty_left}</b></div>
      </div>
      <div style="display:flex;align-items:center;gap:8px"><button data-id="${o.id}" class="btn">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button></div>
    </div>`;
    div.querySelector('button').onclick=()=>reserve(o.id);
    list.appendChild(div);
  });
  // –∑–∞–ø—É—Å–∫/–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ç–∏–∫–∞—é—â–µ–≥–æ —Ç–∞–π–º–µ—Ä–∞
  if(timerId) clearInterval(timerId);
  timerId=setInterval(()=>{
    arr.forEach(o=>{
      const el=document.getElementById('tm_'+o.id);
      if(!el) return;
      const mins=Math.max(0, Math.floor((new Date(o.expires_at)-new Date())/60000));
      el.textContent = mins+' –º–∏–Ω';
    });
  }, 1000);
}

async function loadOffers(){
  const base=window.BACKEND_PUBLIC;
  const lat=v('lat'), lng=v('lng'), radius=v('radius');
  async function fetchOffers(useGeo){
    const p=new URLSearchParams({});
    if(useGeo && lat && lng){
      p.set('lat', lat); p.set('lng', lng);
      if(radius) p.set('radius_km', radius);
    }
    const r=await fetch(`${base}/api/v1/offers?${p.toString()}`);
    return r.ok ? r.json() : [];
  }
  let data=await fetchOffers(true);
  if(Array.isArray(data) && data.length===0 && lat && lng){ data=await fetchOffers(false); }
  current = Array.isArray(data) ? data : [];
  render();
}

async function reserve(offerId){
  const base=window.BACKEND_PUBLIC;
  const tgid=window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 'demo';
  const r=await fetch(`${base}/api/v1/reservations`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({offer_id:offerId, buyer_tg_id:String(tgid)})
  });
  if(!r.ok){toast('–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏');return;}
  const data=await r.json();
  location.assign(`/web/buyer/receipt.html?id=${encodeURIComponent(data.id)}`);
}

document.getElementById('btnLoad').onclick=loadOffers;
document.getElementById('btnGeo').onclick=()=>{
  navigator.geolocation.getCurrentPosition(pos=>{
    s('lat', pos.coords.latitude.toFixed(6));
    s('lng', pos.coords.longitude.toFixed(6));
    if(!v('radius')) s('radius','3');
    saveFilters(); loadOffers();
  },_=>toast('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'));
};
document.getElementById('city').onchange=(e)=>{
  const v1=e.target.value; if(v1){ const [la,ln]=v1.split(','); s('lat',la); s('lng',ln); }
};
document.getElementById('btnSave').onclick=saveFilters;
window.addEventListener('load', ()=>{ loadFilters(); loadOffers(); });

const urlParams = new URLSearchParams(location.search);
const paramOffer = urlParams.get('offer');
function focusOffer(id){
  const card = document.querySelector(`[data-offer-id="${id}"]`);
  if(card){ card.scrollIntoView({behavior:'smooth',block:'center'}); card.classList.add('pulse'); setTimeout(()=>card.classList.remove('pulse'),2000); }
}
setTimeout(()=>{ if(paramOffer) focusOffer(paramOffer); }, 800);
</script>
</body></html>
